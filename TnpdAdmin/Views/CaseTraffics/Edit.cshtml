@using TnpdModels
@model TnpdModels.CaseTraffic

@{
    ViewBag.Title = "案件查詢";
    string path = @"C:\website\tnpd\tnpd\TrafficFiles\";
 
   
}

<h2>案件查詢</h2>

@using (Html.BeginForm(null, null, FormMethod.Post, new { enctype = "multipart/form-data" }))
{

    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true)

    <fieldset>
    <legend>Case</legend>
        <input type="hidden" name="pclass" value="@ViewBag.pclass" />
    @Html.HiddenFor(model => model.Id)
    <span style="color: black">辦理情形</span>
    <table class="table table-v">

        <tbody>
        <tr>
            <td style="width: 50%">案號：@Model.CaseID
            </td>
            <td></td>
        </tr>
        <tr>
            <td>案件日期：@Model.InitDate
            </td>
            <td>
            </td>
        </tr>
        @if (Model.Poprocs.Count > 0)
        {
            <tr>
                <td>承辦單位：@Model.Poprocs.FirstOrDefault().assignUnit.ParentUnit.Subject - @Model.Poprocs.FirstOrDefault().assignUnit.Subject
                </td>
                <td>承辦人：@Model.Poprocs.FirstOrDefault().assignMember.Name
                </td>
            </tr>
        }
        <tr>
            <td>預結案日：@Model.Predate
            </td>
            @if (Model.Poprocs.Count > 0)
            {
                <td>案件狀態：@Model.Poprocs.FirstOrDefault().Status
                </td>
            }
            else
            {
                <td>案件狀態：未分派
                </td>
            }
        </tr>
        </tbody>
    </table>
    <span style="color: black">處理紀錄</span>
    <table class="table table-v">
        <thead>
        <tr>
            <th>日期</th>
            <th>承辦單位</th>
            <th>承辦人</th>
            <th>作業</th>
        </tr>
        </thead>
        <tbody>
        @foreach (CaseTrafficPoprocLog log in Model.PoprocslLogs.OrderByDescending(x => x.InitDate))
        {
            <tr>
                <td>
                    @log.InitDate
                </td>
                @if (log.assignUnit != null)
                {
                    <td>
                        @log.assignUnit.ParentUnit.Subject - @log.assignUnit.Subject
                    </td>
                }
                else
                {
                    <td>
                       
                    </td>
                }
                <td>
                    @log.assignMember.Name
                </td>
                <td>
                    @log.Action
                </td>

            </tr>
        }
            

        </tbody>
    </table>
    <span style="color: black">案件資料</span>

    <table class="table table-v">

        <tbody>
        <tr>
            <td>姓名：@Model.Name</td>
            <td>性別：@Model.Gender</td>

        </tr>
        <tr>

            <td colspan="2">身分證字號：@Model.Pid</td>

        </tr>
        <tr>

            <td>電話：@Model.TEL</td>
            <td>職業：@Model.Job</td>
        </tr>
        <tr>

            <td colspan="2">E-mail：@Model.Email</td>

        </tr>
        <tr>

            <td colspan="2">地址：@Model.Address</td>

        </tr>
        <tr>

            <td colspan="2">主題：@Model.Subject</td>
           
        </tr>
        <tr>

            <td colspan="2">違規地點：@Model.violation_place_area @Model.violation_place_road @Model.violation_place</td>
        </tr>
        <tr>

            <td colspan="2">違規時間：@Model.violation_date.ToString("yyyy/MM/dd")  @Model.violation_time</td>
        </tr>
        <tr>

            <td>違規車號：@Model.violation_carno</td>
            <td>違規事項：@Model.itemno</td>
        </tr>
        <tr>

            <td colspan="2">內容：<br />
                @Html.Raw(UIUtility.Txt2Html(Model.Content))
            </td>

        </tr>
        <tr>

            <td colspan="2">上傳附件檔1：<br />
                @if (!string.IsNullOrEmpty(Model.Upfile1))
                {
                   
                    FileInfo finfo = new FileInfo(path + Model.Upfile1);
                    if (finfo.Exists) {
                         <a href="/TrafficFiles/@Model.Upfile1" target="_black">@Model.Upfile1</a>
                    }else{
                     <a href="http://10.128.0.43:8080/@Model.Upfile1" target="_black">@Model.Upfile1</a>
                    }
                   
                }
                @if (!string.IsNullOrEmpty(Model.Upfile2))
                {
                    FileInfo finfo = new FileInfo(path + Model.Upfile2);
                    if (finfo.Exists) { 
                         <br/>  <a href="/TrafficFiles/@Model.Upfile2" target="_black">@Model.Upfile2</a>
                    }else{
                        
                   <br/>    <a href="http://10.128.0.43:8080/@Model.Upfile2" target="_black">@Model.Upfile2</a>
                    }
                   
                }
                @if (!string.IsNullOrEmpty(Model.Upfile3))
                {
                    FileInfo finfo = new FileInfo(path + Model.Upfile3);
                    if (finfo.Exists) { 
                         <br/>  <a href="/TrafficFiles/@Model.Upfile3" target="_black">@Model.Upfile3</a>
                    }else{
                        
                   <br/>    <a href="http://10.128.0.43:8080/@Model.Upfile3" target="_black">@Model.Upfile3</a>
                    }
                }
                @if (!string.IsNullOrEmpty(Model.Upfile4))
                {
                   
                    FileInfo finfo = new FileInfo(path + Model.Upfile4);
                    if (finfo.Exists) {
                        <a href="/TrafficFiles/@Model.Upfile4" target="_black">@Model.Upfile4</a>
                    }else{
                        <a href="http://10.128.0.43:8080/@Model.Upfile4" target="_black">@Model.Upfile4</a>
                    }
                   
                }
                @if (!string.IsNullOrEmpty(Model.Upfile5))
                {
                    FileInfo finfo = new FileInfo(path + Model.Upfile5);
                    if (finfo.Exists) { 
                        <br/>  <a href="/TrafficFiles/@Model.Upfile5" target="_black">@Model.Upfile5</a>
                    }else{
                        
                        <br/>    <a href="http://10.128.0.43:8080/@Model.Upfile5" target="_black">@Model.Upfile5</a>
                    }
                   
                }
                @if (!string.IsNullOrEmpty(Model.Upfile6))
                {
                    FileInfo finfo = new FileInfo(path + Model.Upfile6);
                    if (finfo.Exists) { 
                        <br/>  <a href="/TrafficFiles/@Model.Upfile6" target="_black">@Model.Upfile6</a>
                    }else{
                        
                        <br/>    <a href="http://10.128.0.43:8080/@Model.Upfile6" target="_black">@Model.Upfile6</a>
                    }
                }
            </td>

        </tr>
     


        </tbody>
    </table>
@if (Model.Poprocs.Count > 0)
{
    <table class="table table-v">
       
       
        <tr>
            <td colspan="2">
                回覆附件：
                @if (!string.IsNullOrEmpty(Model.Poprocs.FirstOrDefault().Upfile1))
                {
                    <a href="/Casefiles/@Model.Poprocs.FirstOrDefault().Upfile1" target="_black">@Model.Poprocs.FirstOrDefault().Upfile1</a>
                }
                else
                {
                    <span>無上傳附件</span>
                }
               
            </td>
        </tr>
        <tr>
            <td colspan="2">
                回覆情形：
                @if (Model.Poprocs.FirstOrDefault().PoprocsType == 1)
                {
                    <span>不舉發</span>
                    <div>不舉發原因：@Model.Poprocs.FirstOrDefault().ViolationsRejectclass.Subject</div>
                    
                }
                else if (Model.Poprocs.FirstOrDefault().PoprocsType == 2)
                {
                    <span>舉發</span>
                    <div>舉發原因：@Model.Poprocs.FirstOrDefault().ViolationsClass.Subject</div>
                }
               
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <div style="text-align: center">回覆內容</div>
                @Html.Raw(UIUtility.Txt2Html(Model.Poprocs.FirstOrDefault().AssignMemo))

            </td>
        </tr>

    </table>
}
  

        
    <div>
        
       
    </div>
    <p align="center">
        <input name="processtype" id="processtype" value="" type="hidden" />
        <input type="button" id="btnRestone" value="案件狀態回復" style="display: none"/>
        @if (Model.Poprocs.Count > 0 && Model.Poprocs.FirstOrDefault().Status == CaseProcessStatus.結案)
        {
            <input type="button" id="btnSendMail" value="寄送結案通知"/>
            
        }
        <div>
            <a href="/CaseTraffics/Print2/@Model.Id" target="_black">列印</a>|
            <a href="/CaseTraffics/Print2all/@Model.Id" target="_black">列印(含個資資料)</a>

        </div>
        <input type="button" onclick="history.back()" value="回到上一頁"/>
       
    </p>
    </fieldset>
}
<style>
    label {
        display: inline;
        font-size: 16px;
        font-weight: 600;
    }
</style>
   
@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    @Scripts.Render("~/bundles/jqueryui")
    @Styles.Render("~/Content/themes/base/css")
    <script>
        $(document).ready(function () {
            $(".datepicker").datepicker();

            $("#btnRestone").click(function () {
                $("#processtype").val("Restone");
                $("form").submit();
            });
            $("#btnSendMail").click(function () {
                $("#processtype").val("SendMail");
                $("form").submit();
            });
          



        });


    </script>
  
    

}

@if (ViewBag.message != null)
{
    <script>
        alert("@ViewBag.message");
        window.location.href = "/CaseTraffics/Index";
    </script>
}
